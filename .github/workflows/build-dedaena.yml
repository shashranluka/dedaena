name: Deploy Dedaena

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.ref_name }}-${{ github.sha }}
  DEPLOY_PATH: /home/luka/dedaena

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Build Docker images
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --tag backend-${{ env.IMAGE_TAG }} \
            --load \
            ./backend
          
          docker buildx build \
            --platform linux/amd64 \
            --tag frontend-${{ env.IMAGE_TAG }} \
            --load \
            ./frontend

      - name: Export Docker images
        run: |
          docker save backend-${{ env.IMAGE_TAG }} | gzip > backend.tar.gz
          docker save frontend-${{ env.IMAGE_TAG }} | gzip > frontend.tar.gz

      - name: Ensure images directory exists
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            mkdir -p ${{ env.DEPLOY_PATH }}/images
      
      - name: Transfer images to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "*.tar.gz"
          target: "${{ env.DEPLOY_PATH }}/images/"
          strip_components: 0

      - name: Load Docker images on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}/images
            
            echo "Loading backend image..."
            docker load -i backend.tar.gz
            
            echo "Loading frontend image..."
            docker load -i frontend.tar.gz
            
            echo "Images loaded successfully"
            docker images | grep ${{ env.IMAGE_TAG }}

      - name: Update Docker Compose configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Updating backend service image..."
            yq eval -i \
              '.services.backend-${{ github.ref_name }}.image = "backend-${{ env.IMAGE_TAG }}"' \
              docker-compose.yml
            
            echo "Updating frontend service image..."
            yq eval -i \
              '.services.frontend-${{ github.ref_name }}.image = "frontend-${{ env.IMAGE_TAG }}"' \
              docker-compose.yml
            
            echo "Configuration updated successfully"

      - name: Deploy backend service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Deploying backend service..."
            docker rollout backend-${{ github.ref_name }}
            
            echo "Backend deployment completed"

      - name: Deploy frontend service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Deploying frontend service..."
            docker rollout frontend-${{ github.ref_name }}
            
            echo "Frontend deployment completed"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Checking service status..."
            docker ps | grep ${{ github.ref_name }} || true
            
            echo "Deployment verification completed"

      - name: Deployment summary
        if: always()
        run: |
          echo "================================"
          echo "Deployment Summary"
          echo "================================"
          echo "Status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Image Tag: ${{ env.IMAGE_TAG }}"
          echo "================================"
